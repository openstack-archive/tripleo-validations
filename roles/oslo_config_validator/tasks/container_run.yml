---
# Copyright 2021 Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# These tasks are wrapping around the oslo-config container creation.

# this shouldn't be necessary once this proposed change has landed
# and propagated in images
# https://review.opendev.org/c/openstack/oslo.config/+/790883
- name: Printing oslo-config command
  when:
    - oslo_config_validator_debug | bool
  debug:
    var: oslo_command

- name: Copying the config file to a temp path
  changed_when: false
  copy:
    mode: 0666
    remote_src: true
    src: "{{ config_file.path }}"
    dest: "{{ oslo_config_validator_work_path }}"

- name: Run oslo-config container
  containers.podman.podman_container:
    name: "{{ container_name }}"
    image: "{{ config_file.image }}"
    state: started
    detach: false
    rm: true
    user: "0"
    mount: "type=bind,source={{ oslo_config_validator_work_path }},destination=/oslo_config_validation"
    network: none
    command: "{{ oslo_command }}"
  register: container_run
  failed_when:
    - false

- name: Printing container run output
  when:
    - oslo_config_validator_debug | bool
  debug:
    var: container_run
