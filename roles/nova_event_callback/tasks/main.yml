---
- name: Get auth_url value from hiera
  become: true
  command: hiera -c /etc/puppet/hiera.yaml neutron::server::notifications::nova::auth_url
  ignore_errors: true
  changed_when: false
  register: auth_url

- name: Get auth_url value from neutron.conf
  become: true
  validations_read_ini:
    path: "{{ neutron_config_file }}"
    section: nova
    key: auth_url
    ignore_missing_file: true
  register: neutron_auth_url_result

- name: Check [nova]/auth_url setting value from neutron.conf
  fail:
    msg: >-
      [nova]/auth_url from {{ neutron_config_file }} is set to
      {{ neutron_auth_url_result.value or 'None' }}
      but it should be set to {{ auth_url.stdout }}.
  failed_when: "neutron_auth_url_result.value != auth_url.stdout"
