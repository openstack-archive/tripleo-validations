---
- name: Retrieving compute services
  ignore_errors: true
  openstack.cloud.compute_service_info:
    cloud: overcloud
  register: result

- name: Fail if the compute services can't be queried
  fail:
    msg: Compute services query failed with {{ result.msg }}
  when: result.failed

- name: Get nova nodes
  set_fact:
    nova_nodes: "{{ result.openstack_compute_services | community.general.json_query(query) }}"
  vars:
    query: "[?contains(name, 'nova')]"

- name: Get failed nova nodes
  set_fact:
    failed_nodes: "{{ nova_nodes | community.general.json_query(failed_nodes_query) }}"
  vars:
    failed_nodes_query: "[?state!='up']"

- when: failed_nodes | length > 0
  block:
    - name: Get baremetal nodes info
      become: true
      openstack.cloud.baremetal_node_info:
        cloud: undercloud
      register: result

    - name: Get baremetal nodes
      set_fact:
        baremetal_nodes: "{{ result.baremetal_nodes }}"

    - name: Get failed node names
      set_fact:
        node_names: "{{ item.host.split('.')[0]}}"
      with_items: "{{ failed_nodes }}"

    - name: Get failed baremetal nodes
      set_fact:
        failed_baremetal_nodes: "{{ baremetal_nodes | to_json | from_json | community.general.json_query(query) }}"
      with_items: "{{ node_names }}"
      vars:
        query: "[?contains(name, '{{ item }}')]"

    - name: Fail if there are unreachable nodes
      fail:
        msg: |
              {{ lookup('template', './templates/unreachable_nodes.j2',
              template_vars=dict(nodes=failed_baremetal_nodes)) }}
      when: failed_baremetal_nodes|length > 0
