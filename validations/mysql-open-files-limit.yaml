---
- hosts: Controller
  vars:
    metadata:
      name: MySQL Open Files Limit
      description: >
        Verify the `open-files-limit` configuration is high enough

        https://access.redhat.com/solutions/1598733
      groups:
        - post-deployment
    min_open_files_limit: 16384
  tasks:
  - include_tasks: tasks/deprecation.yaml

  - name: Set container_cli fact from the inventory
    set_fact:
      container_cli: "{{ hostvars[inventory_hostname].container_cli }}"

  - name: Get the open_files_limit value
    become: true
    shell: >-
      "{{ container_cli|default('podman', true) }}" exec -u root
      $("{{ container_cli|default('podman', true) }}" ps -q --filter "name=mysql|galera-bundle" | head -1)
      /bin/bash -c 'ulimit -n'
    changed_when: False
    register: mysqld_open_files_limit

  - name: Test the open-files-limit value
    fail:
      msg: >
        The open_files_limit option for mysql must be higher than
        {{ min_open_files_limit }}. Right now it's {{ mysqld_open_files_limit.stdout }}.
    failed_when: "mysqld_open_files_limit.stdout|int < min_open_files_limit"
